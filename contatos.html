<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Talkio – Contatos</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:opsz,wght@9..40,400;9..40,500&display=swap" rel="stylesheet">
<style>
:root{--brand:#00C9FF;--brand2:#0077FF;--accent:#FF3CAC;--bg0:#070B14;--bg1:#0C1220;--bg2:#111927;--bg3:#18243A;--t1:#EEF3FF;--t2:#8898B8;--t3:#4A5878;--border:rgba(0,201,255,0.12);--border2:rgba(0,201,255,0.28);--online:#00E676;--away:#FFB300;--busy:#FF3D00;--offline:#455A78;--r-md:14px;--r-full:9999px;--shadow:0 8px 32px rgba(0,0,0,.5);--trans:0.22s cubic-bezier(0.4,0,0.2,1);--font-d:'Syne',sans-serif;--font-b:'DM Sans',sans-serif}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--font-b);background:var(--bg0);color:var(--t1);min-height:100dvh;-webkit-font-smoothing:antialiased;padding-bottom:80px}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
.topbar{position:sticky;top:0;z-index:50;background:rgba(7,11,20,.9);backdrop-filter:blur(12px);height:60px;display:flex;align-items:center;padding:0 16px;gap:12px;border-bottom:1px solid var(--border)}
.logo{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--t1)}
.logo-mark{width:32px;height:32px;border-radius:9px;background:linear-gradient(135deg,var(--brand),var(--brand2));display:flex;align-items:center;justify-content:center}
.logo-name{font-family:var(--font-d);font-weight:800;font-size:1.1rem}
.logo-name span{color:var(--brand)}
.page-title{font-family:var(--font-d);font-weight:700;font-size:1rem;flex:1}
.icon-btn{width:36px;height:36px;border-radius:var(--r-md);display:flex;align-items:center;justify-content:center;color:var(--t2);transition:var(--trans);cursor:pointer;background:none;border:none}
.icon-btn:hover{background:var(--bg2);color:var(--t1)}
.icon-btn svg{width:18px;height:18px}
.search-bar{padding:12px 16px;position:sticky;top:60px;z-index:40;background:rgba(7,11,20,.95);backdrop-filter:blur(8px)}
.search-box{display:flex;align-items:center;gap:8px;background:var(--bg2);border:1px solid var(--border2);border-radius:var(--r-full);padding:10px 16px;transition:var(--trans)}
.search-box:focus-within{border-color:var(--brand);box-shadow:0 0 0 3px rgba(0,201,255,.08)}
.search-box input{background:none;border:none;outline:none;color:var(--t1);font-size:.88rem;font-family:var(--font-b);width:100%}
.search-box input::placeholder{color:var(--t3)}
.search-box svg{color:var(--t3);flex-shrink:0}
.tabs{display:flex;gap:6px;padding:0 16px 12px;border-bottom:1px solid var(--border)}
.tab-btn{padding:6px 16px;border-radius:var(--r-full);font-size:.75rem;font-weight:600;font-family:var(--font-d);color:var(--t3);cursor:pointer;transition:var(--trans);background:none;border:none;text-transform:uppercase;letter-spacing:.04em}
.tab-btn:hover{color:var(--t1);background:var(--bg2)}
.tab-btn.active{color:var(--brand);background:rgba(0,201,255,.1)}
.list-container{padding:8px 12px}
.section-header{padding:8px 8px 4px;font-size:.72rem;font-family:var(--font-d);font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.08em}
.contact-card{display:flex;align-items:center;gap:12px;padding:12px 10px;border-radius:var(--r-md);cursor:pointer;transition:var(--trans)}
.contact-card:hover{background:rgba(0,201,255,.05)}
.av{position:relative;flex-shrink:0}
.av-img,.av-init{width:46px;height:46px;border-radius:50%}
.av-init{display:flex;align-items:center;justify-content:center;font-family:var(--font-d);font-weight:700;font-size:.88rem;color:#000}
.dot{position:absolute;bottom:1px;right:1px;width:11px;height:11px;border-radius:50%;border:2px solid var(--bg0)}
.dot.online{background:var(--online)}.dot.away{background:var(--away)}.dot.busy{background:var(--busy)}.dot.offline{background:var(--offline)}
.c-info{flex:1;min-width:0}
.c-name{font-weight:600;font-size:.9rem}
.c-sub{font-size:.76rem;color:var(--t2);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.c-actions{display:flex;gap:4px}
.c-btn{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;border:none;transition:var(--trans)}
.c-btn.msg{background:rgba(0,201,255,.12);color:var(--brand)}
.c-btn.msg:hover{background:rgba(0,201,255,.25)}
.c-btn.call{background:rgba(0,230,118,.12);color:#00E676}
.c-btn.call:hover{background:rgba(0,230,118,.25)}
.c-btn.del{background:rgba(255,61,0,.1);color:#ff6464}
.c-btn.del:hover{background:rgba(255,61,0,.2)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:9px 18px;border-radius:var(--r-full);font-family:var(--font-d);font-weight:600;font-size:.82rem;cursor:pointer;border:none;transition:var(--trans)}
.btn-primary{background:linear-gradient(135deg,var(--brand2),var(--brand));color:#fff;box-shadow:0 2px 12px rgba(0,201,255,.3)}
.btn-primary:hover{box-shadow:0 4px 20px rgba(0,201,255,.45);transform:translateY(-1px)}
.btn-sm{padding:7px 14px;font-size:.78rem}
.empty{text-align:center;padding:60px 20px;color:var(--t2)}
.empty svg{opacity:.3;margin:0 auto 16px;display:block}
.empty h3{font-family:var(--font-d);font-size:1.1rem;color:var(--t1);margin-bottom:8px}
.modal-overlay{position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;padding:20px}
.modal-overlay.open{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:24px;padding:24px;max-width:400px;width:100%;box-shadow:var(--shadow)}
.modal-title{font-family:var(--font-d);font-weight:700;font-size:1.1rem;margin-bottom:16px}
.form-input{width:100%;background:var(--bg0);border:1px solid var(--border2);border-radius:var(--r-md);padding:12px 16px;color:var(--t1);font-size:.88rem;font-family:var(--font-b);outline:none;transition:var(--trans);margin-bottom:10px}
.form-input:focus{border-color:var(--brand)}
.search-results{max-height:260px;overflow-y:auto;display:flex;flex-direction:column;gap:4px}
.result-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:var(--r-md);cursor:pointer;transition:var(--trans)}
.result-item:hover{background:var(--bg3)}
.result-av{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--font-d);font-weight:700;font-size:.78rem;color:#000;flex-shrink:0}
.result-info{flex:1;min-width:0}
.result-name{font-size:.85rem;font-weight:600}
.result-email{font-size:.74rem;color:var(--t2)}
.result-add{width:30px;height:30px;border-radius:50%;background:rgba(0,201,255,.15);color:var(--brand);display:flex;align-items:center;justify-content:center;cursor:pointer;border:none;transition:var(--trans)}
.result-add:hover{background:rgba(0,201,255,.3)}
.toaster{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:9999;pointer-events:none}
.toast{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r-full);padding:8px 18px;font-size:.82rem;box-shadow:var(--shadow);animation:tin .3s ease,tout .3s ease 2.7s forwards}
@keyframes tin{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
@keyframes tout{from{opacity:1}to{opacity:0}}
.mobile-nav{position:fixed;bottom:0;left:0;right:0;height:64px;background:var(--bg1);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-around;z-index:200}
.mnb{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 12px;cursor:pointer;color:var(--t3);font-size:.62rem;font-family:var(--font-d);font-weight:600;letter-spacing:.04em;transition:var(--trans);background:none;border:none;text-transform:uppercase}
.mnb svg{width:22px;height:22px}.mnb.active{color:var(--brand)}
</style>
</head>
<body>
<div class="topbar">
  <a class="logo" href="chat.html">
    <div class="logo-mark"><svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round" width="18" height="18"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/><circle cx="9" cy="10" r="1" fill="#fff"/><circle cx="12" cy="10" r="1" fill="#fff"/><circle cx="15" cy="10" r="1" fill="#fff"/></svg></div>
    <span class="logo-name">Talk<span>io</span></span>
  </a>
  <span class="page-title">Contatos</span>
  <button class="icon-btn" onclick="openAddModal()" title="Adicionar contato">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
  </button>
</div>

<div class="search-bar">
  <div class="search-box">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    <input type="text" placeholder="Buscar contatos..." id="searchInput" oninput="filterContacts(this.value)">
  </div>
</div>

<div class="tabs">
  <button class="tab-btn active" onclick="setTab(this,'all')">Todos</button>
  <button class="tab-btn" onclick="setTab(this,'online')">Online</button>
  <button class="tab-btn" onclick="setTab(this,'blocked')">Bloqueados</button>
  <button class="tab-btn" onclick="setTab(this,'favorites')">Favoritos</button>
</div>

<div class="list-container" id="listContainer">
  <div class="empty" id="emptyState" style="display:none;">
    <svg viewBox="0 0 24 24" fill="none" stroke="var(--t2)" stroke-width="1.5" width="64" height="64"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
    <h3>Nenhum contato</h3>
    <p style="font-size:.85rem;margin-bottom:16px;">Adicione contatos para começar a conversar</p>
    <button class="btn btn-primary btn-sm" onclick="openAddModal()">Adicionar contato</button>
  </div>
  <div id="contactsList"></div>
</div>

<!-- Add Contact Modal -->
<div class="modal-overlay" id="addModal" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="modal">
    <div class="modal-title">Adicionar contato</div>
    <input class="form-input" type="text" id="searchQuery" placeholder="Nome, e-mail ou @username..." oninput="searchUsers(this.value)">
    <div class="search-results" id="searchResults">
      <div style="text-align:center;color:var(--t3);font-size:.82rem;padding:20px;">Digite para buscar usuários</div>
    </div>
    <button onclick="document.getElementById('addModal').classList.remove('open')" style="width:100%;margin-top:14px;padding:10px;border-radius:var(--r-full);background:var(--bg3);border:1px solid var(--border2);color:var(--t2);cursor:pointer;font-family:var(--font-d);font-weight:600;font-size:.85rem;">Fechar</button>
  </div>
</div>

<div class="toaster" id="toaster"></div>

<nav class="mobile-nav">
  <button class="mnb" onclick="location.href='chat.html'"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" width="22" height="22"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>Chat</button>
  <button class="mnb" onclick="location.href='grupo.html'"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" width="22" height="22"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>Grupos</button>
  <button class="mnb" onclick="location.href='chamada.html'"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" width="22" height="22"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 8.63 19.79 19.79 0 01.12 2.18 2 2 0 012.11 0h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L6.09 7.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>Ligações</button>
  <button class="mnb" onclick="location.href='status.html'"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" width="22" height="22"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>Status</button>
  <button class="mnb" onclick="location.href='perfil.html'"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" width="22" height="22"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>Perfil</button>
</nav>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL='https://vagjwfceaefsmemgcdma.supabase.co';
const SUPABASE_KEY='sb_publishable_4_BgMG0lfghbLC-gRwo2DA_OLQ2EJPz';
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
let currentUser=null,contacts=[],currentTab='all';
const GRAD=['linear-gradient(135deg,#0077FF,#00C9FF)','linear-gradient(135deg,#FF3CAC,#784BA0)','linear-gradient(135deg,#00C9FF,#00E676)','linear-gradient(135deg,#FFB300,#FF3D00)','linear-gradient(135deg,#784BA0,#2B86C5)'];
function grad(id){return GRAD[(id||'').split('').reduce((a,c)=>a+c.charCodeAt(0),0)%GRAD.length];}
function initials(n=''){return n.split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase()||'?';}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

async function init(){
  const{data:{session}}=await sb.auth.getSession();
  if(!session){location.href='index.html';return;}
  currentUser=session.user;
  await loadContacts();
  // Check if came from block action
  const params=new URLSearchParams(location.search);
  if(params.get('block'))setTab(document.querySelector('.tab-btn:nth-child(3)'),'blocked');
}

async function loadContacts(){
  const{data}=await sb.from('contacts').select('*,profiles:contact_id(id,full_name,avatar_url,status,email,phone,bio)').eq('user_id',currentUser.id).order('created_at',{ascending:false});
  contacts=data||[];
  renderContacts(contacts);
}

function renderContacts(list){
  const el=document.getElementById('contactsList');
  const filtered=list.filter(c=>currentTab==='all'?!c.is_blocked:currentTab==='online'?c.profiles?.status==='online'&&!c.is_blocked:currentTab==='blocked'?c.is_blocked:c.is_favorite&&!c.is_blocked);
  if(!filtered.length){document.getElementById('emptyState').style.display='';el.innerHTML='';return;}
  document.getElementById('emptyState').style.display='none';
  // Group by first letter
  const groups={};
  filtered.forEach(c=>{const k=(c.profiles?.full_name||'?')[0].toUpperCase();groups[k]=(groups[k]||[]).concat(c);});
  el.innerHTML=Object.keys(groups).sort().map(letter=>`
    <div class="section-header">${letter}</div>
    ${groups[letter].map(c=>`
      <div class="contact-card" data-id="${c.contact_id}">
        <div class="av">
          <div class="av-init" style="background:${grad(c.contact_id)};">${initials(c.profiles?.full_name||'')}</div>
          <span class="dot ${c.profiles?.status||'offline'}"></span>
        </div>
        <div class="c-info">
          <div class="c-name">${esc(c.profiles?.full_name||'Sem nome')}</div>
          <div class="c-sub">${esc(c.profiles?.email||c.profiles?.phone||'–')}</div>
        </div>
        <div class="c-actions">
          <button class="c-btn msg" onclick="sendMsg('${c.contact_id}')" title="Mensagem"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" width="16" height="16"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg></button>
          <button class="c-btn call" onclick="callContact('${c.contact_id}')" title="Ligar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" width="16" height="16"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 8.63 19.79 19.79 0 01.12 2.18 2 2 0 012.11 0h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L6.09 7.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg></button>
          <button class="c-btn del" onclick="removeContact('${c.contact_id}',this)" title="Remover"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
      </div>`).join('')}`).join('');
}

function filterContacts(q){
  const filtered=contacts.filter(c=>{const name=(c.profiles?.full_name||'').toLowerCase();const email=(c.profiles?.email||'').toLowerCase();return name.includes(q.toLowerCase())||email.includes(q.toLowerCase());});
  renderContacts(filtered);
}

function setTab(btn,tab){currentTab=tab;document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderContacts(contacts);}

function sendMsg(id){location.href='chat.html?contact='+id;}
function callContact(id){location.href='chamada.html?type=voice&contact='+id;}

async function removeContact(id,btn){
  if(!confirm('Remover este contato?'))return;
  await sb.from('contacts').delete().eq('user_id',currentUser.id).eq('contact_id',id);
  contacts=contacts.filter(c=>c.contact_id!==id);
  renderContacts(contacts);showToast('Contato removido');
}

function openAddModal(){document.getElementById('addModal').classList.add('open');document.getElementById('searchQuery').focus();}

let searchTimeout;
function searchUsers(q){
  clearTimeout(searchTimeout);
  if(!q.trim()){document.getElementById('searchResults').innerHTML='<div style="text-align:center;color:var(--t3);font-size:.82rem;padding:20px;">Digite para buscar usuários</div>';return;}
  searchTimeout=setTimeout(async()=>{
    const{data}=await sb.from('profiles').select('*').or(`full_name.ilike.%${q}%,email.ilike.%${q}%,username.ilike.%${q}%`).neq('id',currentUser.id).limit(15);
    const results=data||[];
    const myIds=new Set(contacts.map(c=>c.contact_id));
    document.getElementById('searchResults').innerHTML=results.length?results.map(u=>`
      <div class="result-item">
        <div class="result-av" style="background:${grad(u.id)};">${initials(u.full_name||u.email||'')}</div>
        <div class="result-info"><div class="result-name">${esc(u.full_name||'Sem nome')}</div><div class="result-email">${esc(u.email||'')}</div></div>
        ${myIds.has(u.id)?'<span style="font-size:.72rem;color:var(--brand);">Adicionado</span>':`<button class="result-add" onclick="addContact('${u.id}',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" width="14" height="14"><path d="M12 5v14M5 12h14"/></svg></button>`}
      </div>`).join(''):'<div style="text-align:center;color:var(--t3);font-size:.82rem;padding:20px;">Nenhum usuário encontrado</div>';
  },400);
}

async function addContact(id,btn){
  await sb.from('contacts').upsert({user_id:currentUser.id,contact_id:id},{onConflict:'user_id,contact_id'});
  btn.outerHTML='<span style="font-size:.72rem;color:var(--brand);">Adicionado</span>';
  await loadContacts();showToast('Contato adicionado!');
}

function showToast(m){const t=document.createElement('div');t.className='toast';t.textContent=m;document.getElementById('toaster').appendChild(t);setTimeout(()=>t.remove(),3000);}
init();
</script>
</body>
</html>
